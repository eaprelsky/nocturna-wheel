<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nocturna Wheel.js - Interactive Natal Chart Library</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Nocturna Wheel CSS -->
    <link href="/assets/css/nocturna-wheel.css" rel="stylesheet">
    <link href="/assets/css/demo.css" rel="stylesheet">

    <!-- Preload critical external scripts -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" as="script" crossorigin>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="https://www.nocturna.ru">
                <img src="/assets/png/nocturna-logo.png" alt="Nocturna Logo" class="logo" width="auto" height="80">
            </a>
            <a class="navbar-brand" href="#">
                <span class="brand-text">Nocturna Wheel JS</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Demo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#documentation">Documentation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/eaprelsky/nocturna-wheel" target="_blank">
                            <i class="fab fa-github"></i> GitHub
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-container">
        <div class="row">
            <div class="col-12">
                <div class="demo-card intro-card">
                    <h2 class="demo-title">Interactive Natal Chart Demo</h2>
                    <p>
                        Explore the features and capabilities of the Nocturna Wheel.js library.
                        This SVG-based astrological chart visualization provides a beautiful and
                        interactive way to display natal charts.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- Chart Display Area - Made narrower -->
            <div class="col-lg-6">
                <div class="demo-card">
                    <h3 class="demo-title">Natal Chart</h3>
                    <div id="chart-container" class="chart-container"></div>
                </div>
            </div>
            
            <!-- Controls Area - Made wider -->
            <div class="col-lg-6">
                <div class="demo-card control-panel">
                    <h3 class="demo-title">Chart Controls</h3>
                    
                    <!-- House Controls -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#houses-controls">
                            Houses <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="houses-controls" class="collapse show section-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggle-houses" checked>
                                <label class="form-check-label" for="toggle-houses">Show Houses</label>
                            </div>
                            
                            <div class="control-group mt-3">
                                <label for="house-system" class="form-label">House System</label>
                                <select class="form-select form-select-sm" id="house-system">
                                    <!-- House systems will be populated dynamically -->
                                </select>
                                <small class="text-muted mt-1 d-block" id="house-system-description"></small>
                            </div>
                            
                            <div class="rotation-control">
                                <label for="house-rotation" class="form-label">House Rotation: <span id="rotation-value">0°</span></label>
                                <input type="range" class="form-range" min="0" max="359" value="0" id="house-rotation">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Primary Planet Controls (Outer Circle) -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#primary-planet-controls">
                            Primary Planets (Outer Circle) <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="primary-planet-controls" class="collapse show section-body">
                            <div id="primary-planet-toggles">
                                <!-- Dynamically generated primary planet controls -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secondary Planet Controls (Inner Circle) -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#secondary-planet-controls">
                            Secondary Planets (Inner Circle) <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="secondary-planet-controls" class="collapse show section-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="toggle-secondary-planets" checked>
                                <label class="form-check-label" for="toggle-secondary-planets">Show Inner Circle</label>
                            </div>
                            
                            <div id="secondary-planet-toggles">
                                <!-- Dynamically generated secondary planet controls -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Primary Aspects Controls -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#primary-aspect-controls">
                            Primary Aspects (Outer Circle) <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="primary-aspect-controls" class="collapse show section-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="toggle-primary-aspects" checked>
                                <label class="form-check-label" for="toggle-primary-aspects">Show Primary Aspects</label>
                            </div>
                            
                            <div id="primary-aspect-types" class="aspect-types-container">
                                <!-- Dynamically generated primary aspect controls -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secondary Aspects Controls -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#secondary-aspect-controls">
                            Secondary Aspects (Inner Circle) <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="secondary-aspect-controls" class="collapse show section-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="toggle-secondary-aspects" checked>
                                <label class="form-check-label" for="toggle-secondary-aspects">Show Secondary Aspects</label>
                            </div>
                            
                            <div id="secondary-aspect-types" class="aspect-types-container">
                                <!-- Dynamically generated secondary aspect controls -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Synastry Aspects Controls -->
                    <div class="control-section">
                        <div class="control-title" data-bs-toggle="collapse" data-bs-target="#synastry-aspect-controls">
                            Synastry Aspects (Outer ↔ Inner) <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="synastry-aspect-controls" class="collapse show section-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="toggle-synastry-aspects" checked>
                                <label class="form-check-label" for="toggle-synastry-aspects">Show Synastry Aspects</label>
                            </div>
                            
                            <div id="synastry-aspect-types" class="aspect-types-container">
                                <!-- Dynamically generated synastry aspect controls -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Documentation Section -->
        <div class="row mt-5" id="documentation">
            <div class="col-12">
                <div class="demo-card">
                    <h2 class="demo-title">Documentation</h2>
                    
                    <h4>Getting Started</h4>
                    <div class="code-block">
                        <pre><code>// Install via npm
npm install nocturna-wheel

// Or include directly in your HTML
&lt;script src="https://unpkg.com/nocturna-wheel/dist/nocturna-wheel.min.js"&gt;&lt;/script&gt;</code></pre>
                    </div>
                    
                    <h4>Basic Usage</h4>
                    <div class="code-block">
                        <pre><code>// Create chart instance
const chart = new NocturnaWheel({
    container: 'chart-container',
    planets: {
        sun: { lon: 85.83 },
        moon: { lon: 133.21 },
        // ... other planets
    },
    houses: [
        { lon: 300.32 },  // 1st house cusp
        // ... other houses
    ]
});

// Render the chart
chart.render();

// Toggle features
chart.togglePlanet('pluto', false);
chart.toggleHouses(false);
chart.togglePrimaryPlanets(true);
chart.toggleSecondaryPlanets(true);</code></pre>
                    </div>
                    
                    <h4>Dual Charts (Synastry, Transits)</h4>
                    <div class="code-block">
                        <pre><code>// Create dual chart with independent inner and outer circles
const wheelChart = new WheelChart({
    container: 'chart-container',
    // Natal chart (outer circle)
    planets: {
        sun: { lon: 85.83, color: '#000000' },
        moon: { lon: 133.21, color: '#000000' },
        // ... other natal planets
    },
    // Transit/Partner chart (inner circle)
    secondaryPlanets: {
        sun: { lon: 115.20, color: '#FF5500' },
        moon: { lon: 200.45, color: '#0066CC' },
        // ... other transit/partner planets
    },
    houses: [
        { lon: 300.32 },  // 1st house cusp
        // ... other houses
    ],
    config: {
        radius: {
            innermost: 90 // Radius for the inner circle
        },
        // Three independent aspect systems
        primaryAspectSettings: { /* natal-to-natal */ },
        secondaryAspectSettings: { /* transit-to-transit */ },
        synastryAspectSettings: { /* natal-to-transit */ }
    }
});

// Render the dual chart
wheelChart.render();

// Control each aspect type independently
wheelChart.togglePrimaryAspects(true);   // Outer circle aspects
wheelChart.toggleSecondaryAspects(false); // Inner circle aspects
wheelChart.toggleSynastryAspects(true);   // Cross-circle aspects</code></pre>
                    </div>
                    
                    <h4>Configuration Options</h4>
                    <p>The Nocturna Wheel.js library provides extensive configuration options:</p>
                    <ul>
                        <li><strong>Dual chart support</strong> - Independent inner and outer circles</li>
                        <li><strong>Three aspect systems</strong> - Primary, Secondary, and Synastry aspects</li>
                        <li><strong>Multiple house systems</strong> - Placidus, Koch, Equal, and more</li>
                        <li><strong>Custom colors and styling</strong> - Full control over colors, line styles, and thickness</li>
                        <li><strong>Projection dots</strong> - Hollow circles showing outer planet projections</li>
                        <li><strong>Custom icon sets</strong> - Use your own planet and sign symbols</li>
                        <li><strong>Interactive tooltips</strong> - Hover information for all elements</li>
                    </ul>
                    
                    <p>For more detailed documentation, please visit the <a href="https://github.com/eaprelsky/nocturna-wheel" class="text-decoration-none" style="color: var(--nocturna-primary);">GitHub repository</a>.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2023 Nocturna. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="https://github.com/eaprelsky/nocturna-wheel" class="github-link">
                        <i class="fab fa-github"></i> GitHub Repository
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- No direct script tags for external resources -->
    <!-- Scripts loaded via async pattern in the next script block -->

    <!-- Demo script -->
    <script>
        // Modern async script loading
        function loadScript(url, callback, isModule = false) {
            const script = document.createElement('script');
            script.src = url;
            script.crossOrigin = "anonymous";
            if (isModule) {
                script.type = "module";
            }
            script.onload = callback || function() {};
            script.onerror = function() {
                console.warn(`Failed to load script: ${url}`);
            };
            document.head.appendChild(script);
        }

        // Load scripts in proper sequence
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load Bootstrap, but don't block if it fails
            loadScript('https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js', function() {
                console.log('Bootstrap loaded successfully');
            });
            
            // Load the UMD module directly - independent of Bootstrap
            loadScript('/dist/nocturna-wheel.umd.js?v=10', initializeChart);
        });

        // Chart initialization function
        function initializeChart() {
            console.log("Initializing Nocturna Wheel chart...");
            
            // Check if Nocturna Wheel is loaded properly
            if (!window.NocturnaWheel) {
                console.error("NocturnaWheel object not found! Library may not have loaded correctly.");
                document.getElementById('chart-container').innerHTML = '<div class="alert alert-danger">Failed to load the chart library. Please check the console for details.</div>';
                return;
            }
            
            // Sample data for the chart
            let chartData = {
                // Primary planets (outer circle)
                planets: {
                    sun: { lon: 85.83, color: '#000000', retrograde: false },
                    moon: { lon: 133.21, color: '#000000', retrograde: false },
                    mercury: { lon: 70.18, color: '#000000', retrograde: true },
                    venus: { lon: 42.57, color: '#000000', retrograde: false },
                    mars: { lon: 112.56, color: '#000000', retrograde: true },
                    jupiter: { lon: 169.48, color: '#000000', retrograde: false },
                    saturn: { lon: 188.04, color: '#000000', retrograde: true },
                    uranus: { lon: 275.25, color: '#000000', retrograde: false },
                    neptune: { lon: 298.32, color: '#000000', retrograde: false },
                    pluto: { lon: 247.12, color: '#000000', retrograde: false }
                },
                // Secondary planets (inner circle) - different positions
                secondaryPlanets: {
                    sun: { lon: 115.20, color: '#FF5500', retrograde: false },
                    moon: { lon: 200.45, color: '#0066CC', retrograde: false },
                    mercury: { lon: 130.90, color: '#009900', retrograde: true },
                    venus: { lon: 95.30, color: '#CC0099', retrograde: false },
                    mars: { lon: 250.75, color: '#CC3300', retrograde: false },
                    jupiter: { lon: 10.15, color: '#9966CC', retrograde: true },
                    saturn: { lon: 45.60, color: '#336633', retrograde: false },
                    uranus: { lon: 320.40, color: '#33CCCC', retrograde: false },
                    neptune: { lon: 280.80, color: '#3366FF', retrograde: true },
                    pluto: { lon: 160.25, color: '#663366', retrograde: false }
                },
                houses: [
                    { lon: 300.32 },  // 1st house cusp
                    { lon: 330.15 },  // 2nd house cusp
                    { lon: 355.24 },  // 3rd house cusp
                    { lon: 20.32 },   // 4th house cusp
                    { lon: 45.15 },   // 5th house cusp
                    { lon: 75.24 },   // 6th house cusp
                    { lon: 120.32 },  // 7th house cusp
                    { lon: 150.15 },  // 8th house cusp
                    { lon: 175.24 },  // 9th house cusp
                    { lon: 200.32 },  // 10th house cusp
                    { lon: 225.15 },  // 11th house cusp
                    { lon: 255.24 }   // 12th house cusp
                ]
            };
            
            // Common chart options
            const chartOptions = {
                container: '#chart-container',
                planets: chartData.planets,
                secondaryPlanets: chartData.secondaryPlanets,
                houses: chartData.houses,
                config: {
                    radius: {
                        innermost: 90
                    },
                    assets: {
                        basePath: "/assets/"
                    },
                    astronomicalData: {
                        ascendant: 300.32,
                        mc: 200.32,
                        latitude: 51.5
                    },
                    houseSettings: {
                        enabled: true,
                        lineColor: "#666666",
                        textColor: "#333333",
                        fontSize: 10,
                        rotationAngle: 0
                    },
                    // Primary aspects (outer circle planets)
                    primaryAspectSettings: {
                        enabled: true,
                        orb: 6,
                        types: {
                            'conjunction': { angle: 0, orb: 8, color: '#000000', lineStyle: 'none', enabled: true, strokeWidth: 1 },
                            'opposition': { angle: 180, orb: 6, color: '#E41B17', lineStyle: 'solid', enabled: true, strokeWidth: 1 },
                            'trine': { angle: 120, orb: 6, color: '#4CC417', lineStyle: 'solid', enabled: true, strokeWidth: 1 },
                            'square': { angle: 90, orb: 6, color: '#F62817', lineStyle: 'dashed', enabled: true, strokeWidth: 1 },
                            'sextile': { angle: 60, orb: 4, color: '#56A5EC', lineStyle: 'dashed', enabled: true, strokeWidth: 1 }
                        }
                    },
                    // Secondary aspects (inner circle planets)
                    secondaryAspectSettings: {
                        enabled: true,
                        orb: 6,
                        types: {
                            'conjunction': { angle: 0, orb: 8, color: '#AA00AA', lineStyle: 'none', enabled: true, strokeWidth: 1 },
                            'opposition': { angle: 180, orb: 6, color: '#FF6600', lineStyle: 'solid', enabled: true, strokeWidth: 1 },
                            'trine': { angle: 120, orb: 6, color: '#00AA00', lineStyle: 'solid', enabled: true, strokeWidth: 1 },
                            'square': { angle: 90, orb: 6, color: '#CC0066', lineStyle: 'dashed', enabled: true, strokeWidth: 1 },
                            'sextile': { angle: 60, orb: 4, color: '#0099CC', lineStyle: 'dashed', enabled: true, strokeWidth: 1 }
                        }
                    },
                    // Synastry aspects (outer to inner circle)
                    synastryAspectSettings: {
                        enabled: true,
                        orb: 6,
                        types: {
                            'conjunction': { angle: 0, orb: 8, color: '#666666', lineStyle: 'none', enabled: true, strokeWidth: 1 },
                            'opposition': { angle: 180, orb: 6, color: '#9933CC', lineStyle: 'solid', enabled: true, strokeWidth: 0.5 },
                            'trine': { angle: 120, orb: 6, color: '#33AA55', lineStyle: 'solid', enabled: true, strokeWidth: 0.5 },
                            'square': { angle: 90, orb: 6, color: '#CC6633', lineStyle: 'dotted', enabled: true, strokeWidth: 0.5 },
                            'sextile': { angle: 60, orb: 4, color: '#5599DD', lineStyle: 'dotted', enabled: true, strokeWidth: 0.5 }
                        }
                    }
                }
            };
            
            // Define a custom factory function that logs creation and adds monitoring
            const customChartFactory = (options) => {
                console.log("Custom factory: Creating enhanced NocturnaWheel instance");
                console.log("Custom factory: planets count =", Object.keys(options.planets || {}).length);
                console.log("Custom factory: secondaryPlanets count =", Object.keys(options.secondaryPlanets || {}).length);
                console.log("Custom factory: first planet pos =", options.planets?.sun?.lon);
                console.log("Custom factory: first secondary planet pos =", options.secondaryPlanets?.sun?.lon);
                
                // Get the NocturnaWheel constructor from the exported UMD
                const { NocturnaWheel } = window.NocturnaWheel;
                
                // Create base chart
                const baseChart = new NocturnaWheel(options);
                
                console.log("Custom factory: chart.planets count =", Object.keys(baseChart.planets || {}).length);
                console.log("Custom factory: chart.secondaryPlanets count =", Object.keys(baseChart.secondaryPlanets || {}).length);
                
                // Enhance with monitoring capabilities
                const originalRender = baseChart.render;
                baseChart.render = function() {
                    console.log("Custom factory: Chart render started");
                    const startTime = performance.now();
                    const result = originalRender.apply(this, arguments);
                    const endTime = performance.now();
                    console.log(`Custom factory: Chart rendered in ${(endTime - startTime).toFixed(2)}ms`);
                    return result;
                };
                
                return baseChart;
            };
            
            // Extract constructors from the global object
            const { WheelChart, NocturnaWheel, AstrologyUtils } = window.NocturnaWheel;
            
            // Initialize chart with factory injection
            let chart;
            try {
                console.log("Using WheelChart with factory injection");
                chart = new WheelChart(chartOptions, customChartFactory);
            } catch (error) {
                console.error("Error initializing chart:", error);
                alert("There was an error initializing the chart. See console for details.");
                return;
            }
            
            // Create a style element for aspect lines
            const aspectStyleElement = document.createElement('style');
            aspectStyleElement.id = 'aspect-line-styles';
            document.head.appendChild(aspectStyleElement);
            
            // Function to update aspect line styles
            function updateAspectLineStyles() {
                let styleRules = '';
                
                // Loop through each aspect type and create a custom style
                Object.entries(chart.chart.config.aspectSettings.types).forEach(([aspectType, config]) => {
                    if (!config) return;
                    
                    const thickness = config.strokeWidth || 1;
                    const color = config.color || '#000000';
                    const lineStyle = config.lineStyle || 'solid';
                    
                    // Skip conjunction as it usually doesn't have lines
                    if (aspectType === 'conjunction') return;
                    
                    // Generate more specific selectors for each aspect type
                    if (aspectType === 'opposition') {
                        // For opposition lines (solid red), target them directly by color
                        styleRules += `
                            /* Opposition: Solid Red Line (${color}) */
                            #chart-container svg line[stroke="${color}"],
                            #chart-container svg path[stroke="${color}"] {
                                stroke-width: ${thickness}px !important;
                            }
                        `;
                    } 
                    else if (aspectType === 'trine') {
                        // For trine lines (solid green), target them directly by color
                        styleRules += `
                            /* Trine: Solid Green Line (${color}) */
                            #chart-container svg line[stroke="${color}"],
                            #chart-container svg path[stroke="${color}"] {
                                stroke-width: ${thickness}px !important;
                            }
                        `;
                    }
                    else if (aspectType === 'square') {
                        // Square uses dashed red lines - target by color AND stroke-dasharray
                        styleRules += `
                            /* Square: Dashed Red Line (${color}) */
                            #chart-container svg line[stroke="${color}"][stroke-dasharray],
                            #chart-container svg path[stroke="${color}"][stroke-dasharray] {
                                stroke-width: ${thickness}px !important;
                            }
                        `;
                    }
                    else if (aspectType === 'sextile') {
                        // Sextile uses dashed blue lines - target by color AND stroke-dasharray
                        styleRules += `
                            /* Sextile: Dashed Blue Line (${color}) */
                            #chart-container svg line[stroke="${color}"][stroke-dasharray],
                            #chart-container svg path[stroke="${color}"][stroke-dasharray] {
                                stroke-width: ${thickness}px !important;
                            }
                        `;
                    }
                });
                
                // Update the style element content
                aspectStyleElement.textContent = styleRules;
                console.log("Updated aspect line styles");
                
                // Apply styles directly to improve chances of success
                setTimeout(() => {
                    try {
                        // Direct DOM manipulation for difficult cases
                        const chartContainer = document.querySelector('#chart-container');
                        if (!chartContainer) return;
                        
                        const svg = chartContainer.querySelector('svg');
                        if (!svg) return;
                        
                        const lines = svg.querySelectorAll('line, path');
                        
                        // Get aspect settings
                        const oppositionColor = chart.chart.config.aspectSettings.types.opposition.color;
                        const oppositionWidth = chart.chart.config.aspectSettings.types.opposition.strokeWidth;
                        
                        const trineColor = chart.chart.config.aspectSettings.types.trine.color;
                        const trineWidth = chart.chart.config.aspectSettings.types.trine.strokeWidth;
                        
                        const squareColor = chart.chart.config.aspectSettings.types.square.color;
                        const squareWidth = chart.chart.config.aspectSettings.types.square.strokeWidth;
                        
                        const sextileColor = chart.chart.config.aspectSettings.types.sextile.color;
                        const sextileWidth = chart.chart.config.aspectSettings.types.sextile.strokeWidth;
                        
                        // Apply thickness directly to each element
                        lines.forEach(line => {
                            const stroke = line.getAttribute('stroke');
                            const hasDashArray = line.hasAttribute('stroke-dasharray');
                            
                            // Apply thickness based on color and dash pattern
                            if (stroke === oppositionColor && !hasDashArray) {
                                line.style.strokeWidth = `${oppositionWidth}px`;
                                line.setAttribute('stroke-width', oppositionWidth);
                            }
                            else if (stroke === trineColor && !hasDashArray) {
                                line.style.strokeWidth = `${trineWidth}px`;
                                line.setAttribute('stroke-width', trineWidth);
                            }
                            else if (stroke === squareColor && hasDashArray) {
                                line.style.strokeWidth = `${squareWidth}px`;
                                line.setAttribute('stroke-width', squareWidth);
                            }
                            else if (stroke === sextileColor && hasDashArray) {
                                line.style.strokeWidth = `${sextileWidth}px`;
                                line.setAttribute('stroke-width', sextileWidth);
                            }
                        });
                    } catch (e) {
                        console.error("Error applying direct line styles:", e);
                    }
                }, 100);
            }
            
            // Render chart
            chart.render();
            
            // Populate house system selector
            const houseSystemSelector = document.getElementById('house-system');
            const houseSystemDescription = document.getElementById('house-system-description');
            const houseSystems = AstrologyUtils.getHouseSystems();
            const availableSystems = Object.keys(houseSystems);
            
            // Add options to the selector
            availableSystems.forEach(system => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                // Set the current system as selected
                if (system === chart.chart.getCurrentHouseSystem()) {
                    option.selected = true;
                    houseSystemDescription.textContent = houseSystems[system];
                }
                houseSystemSelector.appendChild(option);
            });
            
            // Add event listener for house system changes
            houseSystemSelector.addEventListener('change', function(e) {
                const selectedSystem = e.target.value;
                chart.setHouseSystem(selectedSystem);
                houseSystemDescription.textContent = houseSystems[selectedSystem];
            });
            
            // Apply initial styles
            updateAspectLineStyles();

            // Generate PRIMARY planet toggles and controls (outer circle)
            const primaryPlanetToggles = document.getElementById('primary-planet-toggles');
            const primaryPlanets = Object.keys(chartData.planets);

            primaryPlanets.forEach(planet => {
                const planetName = planet.charAt(0).toUpperCase() + planet.slice(1);
                const planetData = chartData.planets[planet];
                const controlDiv = document.createElement('div');
                controlDiv.className = 'planet-item';
                controlDiv.innerHTML = `
                    <div class="form-check form-switch">
                        <input class="form-check-input primary-planet-checkbox" type="checkbox" id="toggle-primary-${planet}" data-planet="${planet}" checked>
                        <label class="form-check-label fw-bold" for="toggle-primary-${planet}">${planetName}</label>
                    </div>
                    <div class="controls-row">
                        <div class="control-group">
                            <div class="control-label">Rotation: <span id="primary-planet-${planet}-rotation-value">${planetData.lon.toFixed(0)}°</span></div>
                            <input type="range" class="form-range primary-planet-rotation" min="0" max="359" value="${planetData.lon.toFixed(0)}" id="primary-planet-${planet}-rotation" data-planet="${planet}">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Color</div>
                            <div class="color-picker-wrapper">
                                <div class="color-preview" style="background-color: ${planetData.color || '#000000'}">
                                    <input type="color" class="primary-planet-color" value="${planetData.color || '#000000'}" id="primary-planet-${planet}-color" data-planet="${planet}">
                                </div>
                                <span class="color-value">${planetData.color || '#000000'}</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="form-check">
                                <input class="form-check-input primary-planet-retrograde" type="checkbox" id="primary-planet-${planet}-retrograde" data-planet="${planet}" ${(planetData.retrograde === true) ? 'checked' : ''}>
                                <label class="form-check-label control-label" for="primary-planet-${planet}-retrograde">Retrograde (R)</label>
                            </div>
                        </div>
                    </div>
                `;
                primaryPlanetToggles.appendChild(controlDiv);
            });
            
            // Generate SECONDARY planet toggles and controls (inner circle)
            const secondaryPlanetToggles = document.getElementById('secondary-planet-toggles');
            const secondaryPlanets = Object.keys(chartData.secondaryPlanets);

            secondaryPlanets.forEach(planet => {
                const planetName = planet.charAt(0).toUpperCase() + planet.slice(1);
                const planetData = chartData.secondaryPlanets[planet];
                const controlDiv = document.createElement('div');
                controlDiv.className = 'planet-item';
                controlDiv.innerHTML = `
                    <div class="form-check form-switch">
                        <input class="form-check-input secondary-planet-checkbox" type="checkbox" id="toggle-secondary-${planet}" data-planet="${planet}" checked>
                        <label class="form-check-label fw-bold" for="toggle-secondary-${planet}">${planetName}</label>
                    </div>
                    <div class="controls-row">
                        <div class="control-group">
                            <div class="control-label">Rotation: <span id="secondary-planet-${planet}-rotation-value">${planetData.lon.toFixed(0)}°</span></div>
                            <input type="range" class="form-range secondary-planet-rotation" min="0" max="359" value="${planetData.lon.toFixed(0)}" id="secondary-planet-${planet}-rotation" data-planet="${planet}">
                        </div>
                        <div class="control-group">
                            <div class="control-label">Color</div>
                            <div class="color-picker-wrapper">
                                <div class="color-preview" style="background-color: ${planetData.color || '#000000'}">
                                    <input type="color" class="secondary-planet-color" value="${planetData.color || '#000000'}" id="secondary-planet-${planet}-color" data-planet="${planet}">
                                </div>
                                <span class="color-value">${planetData.color || '#000000'}</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="form-check">
                                <input class="form-check-input secondary-planet-retrograde" type="checkbox" id="secondary-planet-${planet}-retrograde" data-planet="${planet}" ${(planetData.retrograde === true) ? 'checked' : ''}>
                                <label class="form-check-label control-label" for="secondary-planet-${planet}-retrograde">Retrograde (R)</label>
                            </div>
                        </div>
                    </div>
                `;
                secondaryPlanetToggles.appendChild(controlDiv);
            });

            // Helper function to generate aspect controls
            function generateAspectControls(containerSelector, aspectSettings, prefix) {
                const aspectToggles = document.querySelector(containerSelector);
                const aspectTypes = aspectSettings.types || {};
                const aspectNames = Object.keys(aspectTypes);

                aspectNames.forEach(aspect => {
                    const aspectDef = aspectTypes[aspect];
                    const aspectName = aspect.charAt(0).toUpperCase() + aspect.slice(1);
                    const controlDiv = document.createElement('div');
                    controlDiv.className = 'aspect-item';

                    const styles = { 'None': 'none', 'Solid': 'solid', 'Dashed': 'dashed', 'Dotted': 'dotted' };
                    let styleOptions = '';
                    for (const [label, value] of Object.entries(styles)) {
                        const selected = (aspectDef.lineStyle || 'solid') === value ? 'selected' : '';
                        styleOptions += `<option value="${value}" ${selected}>${label}</option>`;
                    }
                    
                    const currentThickness = aspectDef.strokeWidth || 1;

                    controlDiv.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input ${prefix}-aspect-checkbox" type="checkbox" id="toggle-${prefix}-${aspect}" data-aspect="${aspect}" data-prefix="${prefix}" checked>
                            <label class="form-check-label fw-bold" for="toggle-${prefix}-${aspect}">
                                <span class="aspect-name">
                                    <span class="aspect-indicator" style="display: inline-block; width: 12px; height: 12px; margin-right: 6px; background-color: ${aspectDef.color || '#888888'}; border-radius: 2px; border: 1px solid #ccc;"></span>
                                    ${aspectDef.symbol || ''} ${aspectName}
                                </span>
                            </label>
                        </div>
                        <div class="controls-row">
                            <div class="control-group">
                                <div class="control-label">Color</div>
                                <div class="color-picker-wrapper">
                                    <div class="color-preview" style="background-color: ${aspectDef.color || '#888888'}">
                                        <input type="color" class="${prefix}-aspect-color" value="${aspectDef.color || '#888888'}" id="${prefix}-aspect-${aspect}-color" data-aspect="${aspect}" data-prefix="${prefix}">
                                    </div>
                                    <span class="color-value">${aspectDef.color || '#888888'}</span>
                                </div>
                            </div>
                            <div class="control-group">
                                <div class="control-label">Line Style</div>
                                <select class="form-select form-select-sm ${prefix}-aspect-style" id="${prefix}-aspect-${aspect}-style" data-aspect="${aspect}" data-prefix="${prefix}">
                                    ${styleOptions}
                                </select>
                            </div>
                            <div class="control-group">
                                <div class="control-label">Thickness / Orb</div>
                                <div class="d-flex gap-2">
                                    <input type="number" class="form-control form-control-sm ${prefix}-aspect-thickness" id="${prefix}-aspect-${aspect}-thickness" data-aspect="${aspect}" data-prefix="${prefix}"
                                        min="0.5" max="10" step="0.5" value="${currentThickness}" style="width: 70px;">
                                    <input type="number" class="form-control form-control-sm ${prefix}-aspect-orb" id="${prefix}-aspect-${aspect}-orb" data-aspect="${aspect}" data-prefix="${prefix}"
                                        min="0" max="15" step="0.5" value="${aspectDef.orb || 6}" style="width: 70px;">
                                </div>
                            </div>
                        </div>
                    `;
                    aspectToggles.appendChild(controlDiv);

                    if (aspect === 'conjunction') {
                        controlDiv.querySelector(`#${prefix}-aspect-${aspect}-style`).disabled = true;
                        controlDiv.querySelector(`#${prefix}-aspect-${aspect}-thickness`).disabled = true;
                    }
                });
            }

            // Generate PRIMARY aspect controls (outer circle)
            generateAspectControls('#primary-aspect-types', chart.config.primaryAspectSettings, 'primary');
            
            // Generate SECONDARY aspect controls (inner circle)
            generateAspectControls('#secondary-aspect-types', chart.config.secondaryAspectSettings, 'secondary');
            
            // Generate SYNASTRY aspect controls (cross-circle)
            generateAspectControls('#synastry-aspect-types', chart.config.synastryAspectSettings, 'synastry');

            // Event listeners for controls
            
            // Houses toggle
            document.getElementById('toggle-houses').addEventListener('change', function(e) {
                chart.toggleHouses(e.target.checked);
                
                // Enable/disable house system selector based on toggle
                document.getElementById('house-system').disabled = !e.target.checked;
            });
            
            // House rotation
            const rotationSlider = document.getElementById('house-rotation');
            const rotationValue = document.getElementById('rotation-value');
            
            rotationSlider.addEventListener('input', function(e) {
                const angle = parseInt(e.target.value);
                rotationValue.textContent = angle + '°';
                chart.setHouseRotation(angle);
            });
            
            // PRIMARY Planet toggles
            document.querySelectorAll('.primary-planet-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    const planet = e.target.dataset.planet;
                    const visible = e.target.checked;
                    chart.togglePlanet(planet, visible);
                });
            });
            
            // PRIMARY Planet Rotation Listeners
            document.querySelectorAll('.primary-planet-rotation').forEach(slider => {
                slider.addEventListener('input', function(e) {
                    const planet = e.target.dataset.planet;
                    const angle = parseFloat(e.target.value);
                    document.getElementById(`primary-planet-${planet}-rotation-value`).textContent = `${angle.toFixed(0)}°`;
                    if (chartData.planets[planet]) {
                        chartData.planets[planet].lon = angle;
                        chart.updateData({ planets: chartData.planets });
                    }
                });
            });

            // PRIMARY Planet Color Listeners
            document.querySelectorAll('.primary-planet-color').forEach(picker => {
                picker.addEventListener('input', function(e) {
                    const planet = e.target.dataset.planet;
                    const color = e.target.value;
                    if (chartData.planets[planet]) {
                        chartData.planets[planet].color = color;
                        e.target.parentElement.style.backgroundColor = color;
                        e.target.parentElement.nextElementSibling.textContent = color;
                        chart.updateData({ planets: chartData.planets });
                    }
                });
            });
            
            // PRIMARY Planet Retrograde Listeners
            document.querySelectorAll('.primary-planet-retrograde').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    const planet = e.target.dataset.planet;
                    const isRetrograde = e.target.checked;
                    console.log(`Retrograde checkbox changed for ${planet}: ${isRetrograde}`);
                    if (chartData.planets[planet]) {
                        chartData.planets[planet].retrograde = isRetrograde;
                        console.log(`Updated chartData.planets[${planet}]:`, chartData.planets[planet]);
                        chart.updateData({ planets: chartData.planets });
                    }
                });
            });
            
            // SECONDARY planets toggle (innermost circle)
            const secondaryPlanetsToggle = document.getElementById('toggle-secondary-planets');
            secondaryPlanetsToggle.addEventListener('change', function(e) {
                const visible = e.target.checked;
                chart.toggleSecondaryPlanets(visible);
            });
            
            // SECONDARY Planet toggles
            document.querySelectorAll('.secondary-planet-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    const planet = e.target.dataset.planet;
                    const visible = e.target.checked;
                    chart.togglePlanet(planet, visible);
                });
            });
            
            // SECONDARY Planet Rotation Listeners
            document.querySelectorAll('.secondary-planet-rotation').forEach(slider => {
                slider.addEventListener('input', function(e) {
                    const planet = e.target.dataset.planet;
                    const angle = parseFloat(e.target.value);
                    document.getElementById(`secondary-planet-${planet}-rotation-value`).textContent = `${angle.toFixed(0)}°`;
                    if (chartData.secondaryPlanets[planet]) {
                        chartData.secondaryPlanets[planet].lon = angle;
                        chart.updateData({ secondaryPlanets: chartData.secondaryPlanets });
                    }
                });
            });

            // SECONDARY Planet Color Listeners
            document.querySelectorAll('.secondary-planet-color').forEach(picker => {
                picker.addEventListener('input', function(e) {
                    const planet = e.target.dataset.planet;
                    const color = e.target.value;
                    if (chartData.secondaryPlanets[planet]) {
                        chartData.secondaryPlanets[planet].color = color;
                        e.target.parentElement.style.backgroundColor = color;
                        e.target.parentElement.nextElementSibling.textContent = color;
                        chart.updateData({ secondaryPlanets: chartData.secondaryPlanets });
                    }
                });
            });

            // SECONDARY Planet Retrograde Listeners
            document.querySelectorAll('.secondary-planet-retrograde').forEach(checkbox => {
                checkbox.addEventListener('change', function(e) {
                    const planet = e.target.dataset.planet;
                    const isRetrograde = e.target.checked;
                    if (chartData.secondaryPlanets[planet]) {
                        chartData.secondaryPlanets[planet].retrograde = isRetrograde;
                        chart.updateData({ secondaryPlanets: chartData.secondaryPlanets });
                    }
                });
            });

            // PRIMARY Aspects toggle
            document.getElementById('toggle-primary-aspects').addEventListener('change', function(e) {
                chart.togglePrimaryAspects(e.target.checked);
            });
            
            // SECONDARY Aspects toggle
            document.getElementById('toggle-secondary-aspects').addEventListener('change', function(e) {
                chart.toggleSecondaryAspects(e.target.checked);
            });
            
            // SYNASTRY Aspects toggle
            document.getElementById('toggle-synastry-aspects').addEventListener('change', function(e) {
                chart.toggleSynastryAspects(e.target.checked);
            });
            
            // Helper function for aspect type toggle handlers
            function setupAspectTypeToggles(selector, settingsKey) {
                document.querySelectorAll(selector).forEach(checkbox => {
                    checkbox.addEventListener('change', function(e) {
                        const aspect = e.target.dataset.aspect;
                        const prefix = e.target.dataset.prefix;
                        const isEnabled = e.target.checked;
                        
                        if (chart.config[settingsKey].types[aspect]) {
                            chart.config[settingsKey].types[aspect].enabled = isEnabled;
                            
                            const parentDiv = e.target.closest('.aspect-item');
                            if (parentDiv) {
                                const colorInput = parentDiv.querySelector(`.${prefix}-aspect-color`);
                                const styleInput = parentDiv.querySelector(`.${prefix}-aspect-style`);
                                const thicknessInput = parentDiv.querySelector(`.${prefix}-aspect-thickness`);
                                if (colorInput) colorInput.disabled = !isEnabled;
                                if (styleInput) styleInput.disabled = !isEnabled;
                                if (thicknessInput) thicknessInput.disabled = !isEnabled;
                            }
                            
                            chart.render();
                        }
                    });
                });
            }
            
            // Setup toggles for all three aspect types
            setupAspectTypeToggles('.primary-aspect-checkbox', 'primaryAspectSettings');
            setupAspectTypeToggles('.secondary-aspect-checkbox', 'secondaryAspectSettings');
            setupAspectTypeToggles('.synastry-aspect-checkbox', 'synastryAspectSettings');
            
            // Helper function for aspect color changes
            function setupAspectColorHandlers(selector, settingsKey) {
                document.querySelectorAll(selector).forEach(colorPicker => {
                    colorPicker.addEventListener('input', function(e) {
                        const aspect = e.target.dataset.aspect;
                        const color = e.target.value;
                        const prefix = e.target.dataset.prefix;
                        
                        if (chart.config[settingsKey].types[aspect]) {
                            chart.config[settingsKey].types[aspect].color = color;
                            
                            const colorPreview = e.target.parentElement;
                            if (colorPreview) {
                                colorPreview.style.backgroundColor = color;
                                if (colorPreview.nextElementSibling) {
                                    colorPreview.nextElementSibling.textContent = color;
                                }
                            }
                            
                            const aspectItem = e.target.closest('.aspect-item');
                            if (aspectItem) {
                                const indicator = aspectItem.querySelector('.aspect-indicator');
                                if (indicator) {
                                    indicator.style.backgroundColor = color;
                                }
                            }
                            
                            chart.render();
                        }
                    });
                });
            }
            
            // Setup color handlers for all three aspect types
            setupAspectColorHandlers('.primary-aspect-color', 'primaryAspectSettings');
            setupAspectColorHandlers('.secondary-aspect-color', 'secondaryAspectSettings');
            setupAspectColorHandlers('.synastry-aspect-color', 'synastryAspectSettings');
            
            // Helper function for aspect style changes
            function setupAspectStyleHandlers(selector, settingsKey) {
                document.querySelectorAll(selector).forEach(styleSelect => {
                    styleSelect.addEventListener('change', function(e) {
                        const aspect = e.target.dataset.aspect;
                        const style = e.target.value;
                        
                        if (chart.config[settingsKey].types[aspect]) {
                            chart.config[settingsKey].types[aspect].lineStyle = style;
                            chart.render();
                        }
                    });
                });
            }
            
            // Setup style handlers for all three aspect types
            setupAspectStyleHandlers('.primary-aspect-style', 'primaryAspectSettings');
            setupAspectStyleHandlers('.secondary-aspect-style', 'secondaryAspectSettings');
            setupAspectStyleHandlers('.synastry-aspect-style', 'synastryAspectSettings');
            
            // Helper function for aspect thickness changes
            function setupAspectThicknessHandlers(selector, settingsKey) {
                document.querySelectorAll(selector).forEach(thicknessInput => {
                    thicknessInput.addEventListener('input', function(e) {
                        const aspect = e.target.dataset.aspect;
                        const thickness = parseFloat(e.target.value);
                        
                        if (isNaN(thickness) || thickness < 0.5) {
                            e.target.value = 0.5;
                            return;
                        }
                        
                        if (thickness > 10) {
                            e.target.value = 10;
                            return;
                        }
                        
                        if (chart.config[settingsKey].types[aspect]) {
                            chart.config[settingsKey].types[aspect].strokeWidth = thickness;
                            chart.render();
                        }
                    });
                });
            }
            
            // Setup thickness handlers for all three aspect types
            setupAspectThicknessHandlers('.primary-aspect-thickness', 'primaryAspectSettings');
            setupAspectThicknessHandlers('.secondary-aspect-thickness', 'secondaryAspectSettings');
            setupAspectThicknessHandlers('.synastry-aspect-thickness', 'synastryAspectSettings');
            
            // Helper function for aspect orb changes
            function setupAspectOrbHandlers(selector, settingsKey) {
                document.querySelectorAll(selector).forEach(orbInput => {
                    orbInput.addEventListener('input', function(e) {
                        const aspect = e.target.dataset.aspect;
                        const orb = parseFloat(e.target.value);
                        
                        if (isNaN(orb) || orb < 0) {
                            e.target.value = 0;
                            return;
                        }
                        
                        if (orb > 15) {
                            e.target.value = 15;
                            return;
                        }
                        
                        if (chart.config[settingsKey].types[aspect]) {
                            chart.config[settingsKey].types[aspect].orb = orb;
                            chart.render();
                        }
                    });
                });
            }
            
            // Setup orb handlers for all three aspect types
            setupAspectOrbHandlers('.primary-aspect-orb', 'primaryAspectSettings');
            setupAspectOrbHandlers('.secondary-aspect-orb', 'secondaryAspectSettings');
            setupAspectOrbHandlers('.synastry-aspect-orb', 'synastryAspectSettings');
            
            // Initialize collapsible section functionality
            document.querySelectorAll('.control-title').forEach(title => {
                title.addEventListener('click', function() {
                    this.classList.toggle('collapsed');
                });
            });

            // Update color preview when color changes
            function updateColorPreview(input) {
                const preview = input.parentElement;
                const valueSpan = preview.nextElementSibling;
                preview.style.backgroundColor = input.value;
                valueSpan.textContent = input.value;
            }

            // Initialize all color previews
            document.querySelectorAll('input[type="color"]').forEach(updateColorPreview);
        }
    </script>
</body>
</html>