/**
 * Rollup plugin to convert SVG files to data URLs and generate IconData module
 * This allows icons to be bundled inline with the library
 */
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Converts SVG content to a data URL
 * @param {string} svgContent - The SVG file content
 * @returns {string} Data URL representation
 */
function svgToDataUrl(svgContent) {
    // Clean up the SVG content
    const cleaned = svgContent
        .replace(/\n/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    
    // URL encode the SVG (more efficient than base64 for SVGs)
    const encoded = encodeURIComponent(cleaned)
        .replace(/'/g, '%27')
        .replace(/"/g, '%22');
    
    return `data:image/svg+xml,${encoded}`;
}

/**
 * Reads all SVG files from a directory
 * @param {string} dirPath - Path to the directory containing SVG files
 * @returns {Object} Map of filename (without extension) to data URL
 */
function readSvgFiles(dirPath) {
    const icons = {};
    
    if (!fs.existsSync(dirPath)) {
        console.warn(`SVG directory not found: ${dirPath}`);
        return icons;
    }
    
    const files = fs.readdirSync(dirPath);
    
    files.forEach(file => {
        if (path.extname(file) === '.svg') {
            const filePath = path.join(dirPath, file);
            const svgContent = fs.readFileSync(filePath, 'utf8');
            const dataUrl = svgToDataUrl(svgContent);
            
            // Use filename without extension as key
            const key = path.basename(file, '.svg');
            icons[key] = dataUrl;
        }
    });
    
    return icons;
}

/**
 * Generates the IconData module content
 * @param {Object} icons - Map of icon names to data URLs
 * @returns {string} JavaScript module content
 */
function generateIconDataModule(icons) {
    const timestamp = new Date().toISOString();
    
    let moduleContent = `/**
 * IconData.js
 * Auto-generated module containing inline SVG icons as data URLs
 * Generated at: ${timestamp}
 * 
 * This file is automatically generated by the build process.
 * Do not edit manually - changes will be overwritten.
 */

/**
 * Icon data organized by category
 * All SVG icons are stored as data URLs for inline usage
 */
export const IconData = {
    planets: {},
    signs: {},
    aspects: {}
};

`;

    // Categorize icons
    const planets = {};
    const signs = {};
    const aspects = {};
    
    Object.entries(icons).forEach(([key, dataUrl]) => {
        if (key.startsWith('zodiac-planet-')) {
            const name = key.replace('zodiac-planet-', '');
            planets[name] = dataUrl;
        } else if (key.startsWith('zodiac-sign-')) {
            const name = key.replace('zodiac-sign-', '');
            signs[name] = dataUrl;
        } else if (key.startsWith('zodiac-aspect-')) {
            const name = key.replace('zodiac-aspect-', '');
            aspects[name] = dataUrl;
        }
    });
    
    // Generate planet icons
    moduleContent += '// Planet icons\n';
    Object.entries(planets).forEach(([name, dataUrl]) => {
        moduleContent += `IconData.planets['${name}'] = '${dataUrl}';\n`;
    });
    
    moduleContent += '\n// Zodiac sign icons\n';
    Object.entries(signs).forEach(([name, dataUrl]) => {
        moduleContent += `IconData.signs['${name}'] = '${dataUrl}';\n`;
    });
    
    moduleContent += '\n// Aspect icons\n';
    Object.entries(aspects).forEach(([name, dataUrl]) => {
        moduleContent += `IconData.aspects['${name}'] = '${dataUrl}';\n`;
    });
    
    moduleContent += '\n// Export individual categories for convenience\n';
    moduleContent += 'export const PlanetIcons = IconData.planets;\n';
    moduleContent += 'export const SignIcons = IconData.signs;\n';
    moduleContent += 'export const AspectIcons = IconData.aspects;\n';
    
    moduleContent += '\n// Helper function to check if an icon exists\n';
    moduleContent += `export function hasIcon(category, name) {
    return IconData[category] && IconData[category][name] !== undefined;
}

// Helper function to get an icon data URL
export function getIconDataUrl(category, name) {
    if (hasIcon(category, name)) {
        return IconData[category][name];
    }
    return null;
}
`;
    
    return moduleContent;
}

/**
 * Rollup plugin to generate IconData module from SVG files
 */
export default function svgToDataUrlPlugin(options = {}) {
    const svgDir = options.svgDir || path.resolve(__dirname, '../assets/svg/zodiac');
    const outputFile = options.outputFile || path.resolve(__dirname, '../src/data/IconData.js');
    
    return {
        name: 'svg-to-dataurl',
        
        buildStart() {
            console.log('ðŸŽ¨ Converting SVG icons to data URLs...');
            
            // Read all SVG files
            const icons = readSvgFiles(svgDir);
            const iconCount = Object.keys(icons).length;
            
            console.log(`   Found ${iconCount} SVG icons`);
            
            // Generate the module
            const moduleContent = generateIconDataModule(icons);
            
            // Ensure output directory exists
            const outputDir = path.dirname(outputFile);
            if (!fs.existsSync(outputDir)) {
                fs.mkdirSync(outputDir, { recursive: true });
            }
            
            // Write the module file
            fs.writeFileSync(outputFile, moduleContent, 'utf8');
            
            console.log(`   âœ“ Generated ${outputFile}`);
            console.log(`   âœ“ Planets: ${Object.keys(icons).filter(k => k.includes('planet')).length}`);
            console.log(`   âœ“ Signs: ${Object.keys(icons).filter(k => k.includes('sign')).length}`);
            console.log(`   âœ“ Aspects: ${Object.keys(icons).filter(k => k.includes('aspect')).length}`);
        }
    };
}

